From d07945e78eb6b593cd17a4640c1fc9eb35e3245d Mon Sep 17 00:00:00 2001
From: Prasad J Pandit <pjp@fedoraproject.org>
Date: Fri, 26 Oct 2018 18:03:58 +0530
Subject: [PATCH] ppc/pnv: check size before data buffer access
MIME-Version: 1.0
Content-Type: text/plain; charset=utf8
Content-Transfer-Encoding: 8bit

While performing PowerNV memory r/w operations, the access length
'sz' could exceed the data[4] buffer size. Add check to avoid OOB
access.

Reported-by: Moguofang <moguofang@huawei.com>
Signed-off-by: Prasad J Pandit <pjp@fedoraproject.org>
Reviewed-by: CÃ©dric Le Goater <clg@kaod.org>
Signed-off-by: David Gibson <david@gibson.dropbear.id.au>
---
 hw/ppc/pnv_lpc.c | 8 +++++++-
 1 file changed, 7 insertions(+), 1 deletion(-)

Index: qemu-2.12+dfsg/hw/ppc/pnv_lpc.c
===================================================================
--- qemu-2.12+dfsg.orig/hw/ppc/pnv_lpc.c	2018-11-21 13:15:46.728269878 -0500
+++ qemu-2.12+dfsg/hw/ppc/pnv_lpc.c	2018-11-21 13:15:46.724269862 -0500
@@ -161,9 +161,15 @@ static void pnv_lpc_do_eccb(PnvLpcContro
     /* XXX Check for magic bits at the top, addr size etc... */
     unsigned int sz = (cmd & ECCB_CTL_SZ_MASK) >> ECCB_CTL_SZ_LSH;
     uint32_t opb_addr = cmd & ECCB_CTL_ADDR_MASK;
-    uint8_t data[4];
+    uint8_t data[8];
     bool success;
 
+    if (sz > sizeof(data)) {
+        qemu_log_mask(LOG_GUEST_ERROR,
+            "ECCB: invalid operation at @0x%08x size %d\n", opb_addr, sz);
+        return;
+    }
+
     if (cmd & ECCB_CTL_READ) {
         success = opb_read(lpc, opb_addr, data, sz);
         if (success) {
